# アーキテクチャドキュメント

## システム概要

電車遅延×天気データ相関分析システムは、天候が電車の遅延に与える影響を分析・可視化するPythonアプリケーションです。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                     Streamlit Dashboard                      │
│                         (app.py)                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                    ビジネスロジック層                         │
├─────────────────┬─────────────────┬─────────────────────────┤
│  データ収集      │   データ分析     │      可視化            │
│  ├ train_delay  │  data_analyzer   │  visualization         │
│  └ weather      │                  │                        │
└─────────────────┴─────────────────┴─────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                      データ層                                │
│  ├ CSV Files (data/raw/, data/processed/)                  │
│  └ External APIs (OpenWeatherMap, Railway APIs)            │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. プレゼンテーション層 (app.py)

**責務:**
- ユーザーインターフェースの提供
- データのフィルタリングと表示制御
- ユーザー入力の処理

**主要クラス:**
- `TrainDelayDashboard`: メインダッシュボードクラス

**機能:**
- 5つのタブ（概要、ヒートマップ、時系列分析、詳細データ、インサイト）
- サイドバーでのフィルタリング機能
- データのエクスポート機能

### 2. ビジネスロジック層

#### 2.1 データ収集コンポーネント

**基底クラス (base_collector.py):**
```python
BaseCollector
├── 共通のデータ収集機能
├── データ検証
└── ファイル保存
```

**実装クラス:**
- `TrainDelayCollector`: 電車遅延データの収集
- `WeatherCollector`: 天気データの収集

**データソース:**
- 鉄道会社の公式サイト（スクレイピング）
- OpenWeatherMap API
- サンプルデータ生成機能

#### 2.2 データ分析コンポーネント (data_analyzer.py)

**責務:**
- データのマージと前処理
- 統計計算
- 相関分析
- レポート生成

**主要メソッド:**
- `merge_data()`: 遅延と天気データの結合
- `calculate_delay_statistics()`: 各種統計の計算
- `calculate_correlation()`: 相関係数の算出
- `generate_summary_report()`: 分析レポートの生成

#### 2.3 可視化コンポーネント (visualization.py)

**責務:**
- グラフとチャートの生成
- インタラクティブな可視化

**提供する可視化:**
- 棒グラフ（天候別、路線別、時間帯別、曜日別）
- ヒートマップ（路線×天候）
- 折れ線グラフ（時系列トレンド）
- 散布図（相関分析）

### 3. 設定管理 (config.py)

**責務:**
- アプリケーション全体の設定管理
- 環境変数の管理
- 定数の定義

**設定カテゴリ:**
- API設定
- データ収集設定
- 地域設定
- パス設定
- 分析パラメータ
- 可視化設定

### 4. データ層

**データ形式:**
- CSV形式でのデータ保存
- UTF-8エンコーディング（BOM付き）

**ディレクトリ構造:**
```
data/
├── raw/          # 生データ
│   ├── train_delays_*.csv
│   └── weather_data_*.csv
└── processed/    # 処理済みデータ
```

## データフロー

1. **データ収集フェーズ**
   ```
   外部API/Webサイト → Collector → CSV保存
   ```

2. **データ分析フェーズ**
   ```
   CSV読み込み → データマージ → 統計計算 → 相関分析
   ```

3. **可視化フェーズ**
   ```
   分析済みデータ → Visualizer → Plotlyグラフ → Streamlit表示
   ```

## 設計原則

### 1. 単一責任の原則 (SRP)
各クラスは明確に定義された単一の責務を持つ：
- Collectorクラス: データ収集のみ
- Analyzerクラス: 分析ロジックのみ
- Visualizerクラス: 可視化のみ

### 2. 開放閉鎖の原則 (OCP)
新しい機能の追加が容易：
- 新しい鉄道会社の追加
- 新しい可視化の追加
- 新しい分析手法の追加

### 3. 依存性逆転の原則 (DIP)
- 基底クラス（BaseCollector）による抽象化
- 設定の外部化（Config）

## 拡張性

### 新しいデータソースの追加

1. `BaseCollector`を継承した新しいコレクタークラスを作成
2. `collect_data()`メソッドを実装
3. 必要に応じて固有のメソッドを追加

### 新しい分析手法の追加

1. `TrainDelayAnalyzer`クラスに新しいメソッドを追加
2. 既存のデータ構造を活用
3. 結果を辞書形式で返す

### 新しい可視化の追加

1. `Visualizer`クラスに新しいメソッドを追加
2. Plotlyを使用してグラフを作成
3. `go.Figure`オブジェクトを返す

## パフォーマンス考慮事項

### キャッシング
- Streamlitの`@st.cache_data`デコレータを使用
- 重い計算結果をキャッシュ

### データ処理
- Pandasの効率的な操作を使用
- 大量データの場合はチャンク処理を検討

### 並行処理
- 複数のデータソースからの収集は並行実行可能
- `concurrent.futures`の使用を検討

## セキュリティ考慮事項

### APIキー管理
- 環境変数での管理（.env）
- .gitignoreでの除外

### データ検証
- 入力データの検証
- SQLインジェクション対策（該当する場合）

### エラーハンドリング
- 適切な例外処理
- ユーザーへの適切なエラーメッセージ

## デプロイメント

### ローカル実行
```bash
pip install -r requirements.txt
streamlit run app.py
```

### クラウドデプロイ
- Streamlit Cloud
- Heroku
- AWS EC2 + Docker

### 必要な環境変数
- `WEATHER_API_KEY`: OpenWeatherMap APIキー
- その他の外部サービスのAPIキー

## 今後の改善案

1. **リアルタイムデータ対応**
   - WebSocketによるリアルタイム更新
   - 定期的なデータ収集のスケジューリング

2. **機械学習の統合**
   - 遅延予測モデルの実装
   - 異常検知アルゴリズム

3. **スケーラビリティ**
   - データベースの導入（PostgreSQL等）
   - キューシステムの導入（Redis等）

4. **監視とロギング**
   - 詳細なログ出力
   - メトリクスの収集（Prometheus等）